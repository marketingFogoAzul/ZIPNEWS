<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIPNEWS PRO - Admin</title>
    <style>
        :root { 
            --bg: #ffffff; 
            --card: #f8f9fa; 
            --primary: #e50914; 
            --secondary: #6c757d;
            --text: #212529; 
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            line-height: 1.6;
        }
        
        /* Utilit√°rios */
        .hidden { display: none !important; }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            cursor: pointer; 
            border-radius: 6px; 
            font-weight: 600; 
            margin: 5px; 
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #c40812; transform: translateY(-2px); }
        .btn-sec { background-color: var(--secondary); color: white; }
        .btn-sec:hover { background-color: #5a6268; transform: translateY(-2px); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #c82333; transform: translateY(-2px); }
        .btn-warning { background-color: var(--warning); color: #212529; }
        .btn-warning:hover { background-color: #e0a800; transform: translateY(-2px); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #218838; transform: translateY(-2px); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: #138496; transform: translateY(-2px); }
        .btn-outline { 
            background: transparent; 
            border: 2px solid var(--primary); 
            color: var(--primary);
        }
        .btn-outline:hover { 
            background: var(--primary); 
            color: white;
        }
        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        input, textarea, select { 
            background: white; 
            border: 2px solid var(--border); 
            color: var(--text); 
            padding: 12px; 
            width: 100%; 
            margin-bottom: 15px; 
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.1);
        }
        
        /* Layout */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .card { 
            background-color: var(--card); 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }
        
        /* Grid de Categorias */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        .cat-item { 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
            cursor: pointer; 
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .cat-item:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .cat-item.pinned {
            border: 2px solid var(--warning);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }
        .cat-thumb { 
            width: 100%; 
            height: 160px; 
            object-fit: cover;
            display: block;
        }
        .cat-info { 
            padding: 20px; 
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .cat-info strong { 
            font-size: 18px; 
            color: var(--text); 
            margin-bottom: 8px;
            display: block;
        }
        .cat-meta {
            font-size: 12px;
            color: var(--secondary);
            margin-top: auto;
        }
        .cat-actions { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            display: flex; 
            gap: 5px; 
        }
        .cat-btn { 
            background: rgba(255,255,255,0.9); 
            color: var(--text); 
            border: none; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            cursor: pointer; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }
        .cat-btn:hover {
            transform: scale(1.1);
            background: white;
        }
        .pin-btn {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }

        /* Divisores */
        .divisor-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
        }
        .divisor-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .divisor-item .cat-info strong {
            color: white;
            text-align: center;
        }
        .divisor-item .cat-meta {
            color: rgba(255,255,255,0.8);
            text-align: center;
        }
        .divisor-item .cat-thumb {
            display: none;
        }

        /* Modal */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 20px;
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 100%; 
            max-width: 500px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h3 {
            margin: 0;
            color: var(--text);
            font-size: 20px;
        }
        .modal-close { 
            background: none; 
            border: none; 
            color: var(--secondary); 
            font-size: 24px; 
            cursor: pointer; 
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .modal-close:hover {
            background: #f8f9fa;
            color: var(--text);
        }
        
        /* Cabe√ßalhos */
        .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .category-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 28px;
            font-weight: 700;
        }
        
        /* A√ß√µes */
        .category-actions { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        /* Lista de posts e divisores */
        .post-item, .divisor-list-item { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: background-color 0.3s ease;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .post-item:hover, .divisor-list-item:hover { 
            background: #f8f9fa;
            transform: translateX(5px);
        }
        .post-item:last-child, .divisor-list-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Preview */
        .preview-content { 
            background: white; 
            width: 100%; 
            max-width: 800px; 
            max-height: 90vh; 
            overflow-y: auto; 
            padding: 30px; 
            border-radius: 12px; 
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .media-preview img, .media-preview iframe { 
            max-width: 100%; 
            margin-bottom: 20px; 
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* T√≠tulos e textos */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text);
            font-weight: 700;
            margin-top: 0;
        }
        
        h1 { font-size: 32px; margin-bottom: 10px; }
        h2 { font-size: 28px; margin-bottom: 15px; }
        h3 { font-size: 24px; margin-bottom: 15px; }
        
        /* Status e badges */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary);
        }
        .empty-state h4 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .pinned-badge {
            background: var(--warning);
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .divisor-badge {
            background: var(--info);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Form groups */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #d4edda;
            border-color: var(--success);
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border-color: var(--danger);
            color: #721c24;
        }
        
        /* Se√ß√µes */
        .pinned-section {
            margin-bottom: 30px;
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--text);
        }
        .section-title .badge {
            background: var(--warning);
            color: #212529;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Links de imagem */
        .image-help {
            font-size: 12px;
            color: var(--secondary);
            margin-top: 5px;
        }
        .image-help a {
            color: var(--primary);
            text-decoration: none;
        }
        .image-help a:hover {
            text-decoration: underline;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--secondary);
        }
        .breadcrumb span {
            color: var(--primary);
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Tela de Login -->
    <div id="loginScreen" class="card">
        <h1 style="color: var(--primary); text-align: center; margin-bottom: 30px;">ZIPNEWS PRO</h1>
        <div class="form-group">
            <input type="text" id="username" placeholder="Usu√°rio">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="Senha">
        </div>
        <div class="form-group">
            <input type="text" id="coupon" placeholder="Cupom de Acesso" style="border-color: var(--primary);">
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-primary" onclick="handleAuth('login')">Entrar</button>
            <button class="btn btn-outline" onclick="handleAuth('register')">Registrar</button>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboardScreen" class="hidden">
        <div class="category-header">
            <h1>Ecosistema Amanda IA</h1>
            <button class="btn btn-sec" onclick="logout()">Sair</button>
        </div>

        <div class="card">
            <h3>Criar Nova Categoria</h3>
            <div class="form-group">
                <input type="text" id="newCatName" placeholder="Nome da Categoria">
            </div>
            <div class="form-group">
                <input type="text" id="newCatThumb" placeholder="Link da Imagem (Obrigat√≥rio)">
                <div class="image-help">
                    üí° Use <a href="https://imgbb.com/" target="_blank">ImgBB.com</a> para fazer upload gratuito das suas imagens
                </div>
            </div>
            <button class="btn btn-primary" onclick="createCategory()">+ Criar Categoria</button>
        </div>

        <!-- Categorias Fixadas -->
        <div id="pinnedSection" class="pinned-section hidden">
            <div class="section-title">
                <h2>Categorias em Destaque</h2>
                <span class="badge">Fixadas</span>
            </div>
            <div id="pinnedCategoriesList" class="grid"></div>
        </div>

        <!-- Todas as Categorias -->
        <h2>Suas Categorias</h2>
        <div id="categoriesList" class="grid"></div>
    </div>

    <!-- Tela da Categoria (lista de divisores) -->
    <div id="categoryScreen" class="hidden">
        <div class="breadcrumb">
            <button class="btn btn-sec btn-sm" onclick="showDashboard()">‚Üê Categorias</button>
            <span>></span>
            <span id="currentCatBreadcrumb">Categoria</span>
        </div>

        <div class="category-header">
            <h2 id="currentCatTitle">Categoria</h2>
            <button class="btn btn-warning" onclick="editCurrentCategory()">Editar Categoria</button>
        </div>
        
        <!-- A√á√ïES DENTRO DA CATEGORIA -->
        <div class="category-actions">
            <button class="btn btn-info" onclick="showDivisorCreator()">
                + Criar Divisor
            </button>
        </div>

        <div class="card">
            <h3>Divisores desta Categoria</h3>
            <div id="divisorsList"></div>
        </div>
    </div>

    <!-- Tela do Divisor (lista de mat√©rias) -->
    <div id="divisorScreen" class="hidden">
        <div class="breadcrumb">
            <button class="btn btn-sec btn-sm" onclick="showDashboard()">Categorias</button>
            <span>></span>
            <button class="btn btn-sec btn-sm" onclick="backToCategory()" id="backToCategoryBtn">Categoria</button>
            <span>></span>
            <span id="currentDivisorBreadcrumb">Divisor</span>
        </div>

        <div class="category-header">
            <h2 id="currentDivisorTitle">Divisor</h2>
        </div>
        
        <!-- A√á√ïES DENTRO DO DIVISOR -->
        <div class="category-actions">
            <button class="btn btn-primary" onclick="showEditor()">
                + Criar Mat√©ria
            </button>
        </div>

        <div class="card">
            <h3>Mat√©rias deste Divisor</h3>
            <div id="postsList"></div>
        </div>
    </div>

    <!-- Editor de Mat√©ria -->
    <div id="editorScreen" class="hidden">
        <div class="breadcrumb">
            <button class="btn btn-sec btn-sm" onclick="showDashboard()">Categorias</button>
            <span>></span>
            <button class="btn btn-sec btn-sm" onclick="backToCategory()" id="editorBackToCategoryBtn">Categoria</button>
            <span>></span>
            <button class="btn btn-sec btn-sm" onclick="backToDivisor()" id="editorBackToDivisorBtn">Divisor</button>
            <span>></span>
            <span>Nova Mat√©ria</span>
        </div>

        <div class="category-header">
            <h2>Nova Mat√©ria</h2>
        </div>
        
        <div class="card">
            <div class="form-group">
                <label>T√≠tulo:</label>
                <input type="text" id="postTitle" placeholder="Digite o t√≠tulo da mat√©ria...">
            </div>
            
            <div class="form-group">
                <label>Autor:</label>
                <input type="text" id="postAuthor" readonly style="background: #f8f9fa; color: #6c757d;">
            </div>

            <div class="form-group">
                <label>Data/Hora (SP):</label>
                <input type="text" id="postDate" readonly style="background: #f8f9fa; color: #6c757d;">
            </div>

            <div class="form-group">
                <label>Conte√∫do (Texto):</label>
                <textarea id="postContent" rows="8" placeholder="Digite o conte√∫do da mat√©ria..."></textarea>
            </div>

            <div class="form-group">
                <label>M√≠dias (Links de Imagem ou V√≠deo - Ilimitado):</label>
                <div id="mediaInputs">
                    <input type="text" class="media-link" placeholder="Cole o link da imagem ou v√≠deo aqui...">
                </div>
                <button class="btn btn-outline" onclick="addMediaInput()" style="margin-top: 10px;">+ Adicionar outro link</button>
                <div class="image-help">
                    üí° Para imagens: use <a href="https://imgbb.com/" target="_blank">ImgBB.com</a> | 
                    Para v√≠deos: cole link do YouTube
                </div>
            </div>

            <hr style="border-color: var(--border); margin: 30px 0;">
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-sec" onclick="openPreview()">Visualizar como ficou</button>
                <button class="btn btn-primary" onclick="savePost()">Salvar Mat√©ria</button>
            </div>
        </div>
    </div>

    <!-- Criador de Divisor -->
    <div id="divisorCreatorScreen" class="hidden">
        <div class="breadcrumb">
            <button class="btn btn-sec btn-sm" onclick="showDashboard()">Categorias</button>
            <span>></span>
            <button class="btn btn-sec btn-sm" onclick="backToCategory()" id="divisorBackToCategoryBtn">Categoria</button>
            <span>></span>
            <span>Novo Divisor</span>
        </div>

        <div class="category-header">
            <h2>Novo Divisor</h2>
        </div>
        
        <div class="card">
            <div class="form-group">
                <label>Nome do Divisor:</label>
                <input type="text" id="divisorName" placeholder="Ex: Not√≠cias 2024, Promo√ß√µes, etc.">
                <div class="image-help">
                    üí° Divisores organizam as mat√©rias dentro das categorias
                </div>
            </div>
            
            <hr style="border-color: var(--border); margin: 30px 0;">
            
            <button class="btn btn-info" onclick="createDivisor()">Criar Divisor</button>
        </div>
    </div>
</div>

<!-- Modal de Preview -->
<div id="previewModal" class="modal hidden">
    <div class="preview-content">
        <h2 id="prevTitle" style="color: var(--primary); margin-bottom: 10px;"></h2>
        <small id="prevMeta" style="color: var(--secondary); display: block; margin-bottom: 20px;"></small>
        <div id="prevMedia" class="media-preview" style="margin-top: 20px;"></div>
        <div id="prevText" style="margin-top: 25px; line-height: 1.8; color: var(--text); white-space: pre-wrap; font-size: 16px;"></div>
        <button class="btn btn-danger" onclick="closePreview()" style="width: 100%; margin-top: 30px; padding: 15px;">Fechar Visualiza√ß√£o</button>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Categoria -->
<div id="editCategoryModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Editar Categoria</h3>
            <button class="modal-close" onclick="closeEditCategoryModal()">√ó</button>
        </div>
        <div class="form-group">
            <input type="text" id="editCatName" placeholder="Nome da Categoria">
        </div>
        <div class="form-group">
            <input type="text" id="editCatThumb" placeholder="Link da Imagem (Obrigat√≥rio)">
            <div class="image-help">
                üí° Use <a href="https://imgbb.com/" target="_blank">ImgBB.com</a> para imagens gratuitas
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-primary" onclick="updateCategory()">Salvar Altera√ß√µes</button>
            <button class="btn btn-sec" onclick="closeEditCategoryModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal de Edi√ß√£o de Mat√©ria -->
<div id="editPostModal" class="modal hidden">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Editar Mat√©ria</h3>
            <button class="modal-close" onclick="closeEditPostModal()">√ó</button>
        </div>
        <div class="form-group">
            <input type="text" id="editPostTitle" placeholder="T√≠tulo da mat√©ria">
        </div>
        <div class="form-group">
            <textarea id="editPostContent" rows="6" placeholder="Conte√∫do da mat√©ria"></textarea>
        </div>
        <div class="form-group">
            <label>M√≠dias:</label>
            <div id="editMediaInputs">
                <!-- Preenchido dinamicamente -->
            </div>
            <button type="button" class="btn btn-outline" onclick="addEditMediaInput()" style="margin-top: 10px;">+ Adicionar link</button>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn btn-primary" onclick="updatePost()">Salvar Altera√ß√µes</button>
            <button class="btn btn-sec" onclick="closeEditPostModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:3000';
    let currentUser = null;
    let currentCategoryId = null;
    let currentCategoryName = null;
    let currentCategoryThumb = null;
    let currentDivisorId = null;
    let currentDivisorName = null;
    let editingCategoryId = null;
    let editingPostId = null;
    let todasCategorias = [];

    // --- FUN√á√ïES DE AUTH ---
    async function handleAuth(action) {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const coupon = document.getElementById('coupon').value;

        if(!user || !pass || !coupon) return alert('Preencha tudo!');

        try {
            const res = await fetch(`${API_URL}/auth`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: user, password: pass, coupon: coupon, action: action })
            });
            
            const data = await res.json();
            if(data.success) {
                if(action === 'register') {
                    alert('Registrado! Agora fa√ßa login.');
                } else {
                    currentUser = data.user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    showDashboard();
                }
            } else {
                alert(data.error);
            }
        } catch (error) {
            console.error('Erro de autentica√ß√£o:', error);
            alert('Erro de conex√£o com o servidor');
        }
    }

    function logout() { location.reload(); }

    // --- DASHBOARD & CATEGORIAS ---
    async function showDashboard() {
        hideAllScreens();
        document.getElementById('dashboardScreen').classList.remove('hidden');
        await loadCategories();
    }

    function hideAllScreens() {
        document.getElementById('dashboardScreen').classList.add('hidden');
        document.getElementById('categoryScreen').classList.add('hidden');
        document.getElementById('divisorScreen').classList.add('hidden');
        document.getElementById('editorScreen').classList.add('hidden');
        document.getElementById('divisorCreatorScreen').classList.add('hidden');
    }

    async function loadCategories() {
        try {
            const res = await fetch(`${API_URL}/categories`);
            if (!res.ok) throw new Error('Erro ao carregar categorias');
            
            todasCategorias = await res.json();
            
            const grid = document.getElementById('categoriesList');
            const pinnedGrid = document.getElementById('pinnedCategoriesList');
            const pinnedSection = document.getElementById('pinnedSection');
            
            grid.innerHTML = '';
            pinnedGrid.innerHTML = '';

            // Separar categorias fixadas e normais
            const pinnedCats = todasCategorias.filter(cat => cat.pinned);
            const normalCats = todasCategorias.filter(cat => !cat.pinned);

            // Mostrar se√ß√£o de fixadas se houver
            if (pinnedCats.length > 0) {
                pinnedSection.classList.remove('hidden');
                pinnedCats.forEach(c => renderCategory(c, pinnedGrid, true));
            } else {
                pinnedSection.classList.add('hidden');
            }

            if (normalCats.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h4>Nenhuma categoria criada ainda</h4>
                        <p>Crie sua primeira categoria para come√ßar!</p>
                    </div>
                `;
                return;
            }

            normalCats.forEach(c => renderCategory(c, grid, false));
        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
            alert('Erro ao carregar categorias do servidor');
        }
    }

    function renderCategory(c, container, isPinned) {
        const div = document.createElement('div');
        div.className = `cat-item ${isPinned ? 'pinned' : ''}`;
        
        div.innerHTML = `
            <div class="cat-actions">
                <button class="cat-btn pin-btn" onclick="togglePinCategory(event, ${c.id}, ${!c.pinned})" title="${c.pinned ? 'Desfixar' : 'Fixar'}">
                    üìå
                </button>
                <button class="cat-btn btn-warning" onclick="editCategory(event, ${c.id}, '${c.name.replace(/'/g, "\\'")}', '${c.thumb_url.replace(/'/g, "\\'")}')" title="Editar">E</button>
                <button class="cat-btn btn-danger" onclick="deleteCategory(event, ${c.id})" title="Excluir">X</button>
            </div>
            <img src="${c.thumb_url}" class="cat-thumb" onerror="this.src='https://i.ibb.co/0jQY8L9/placeholder-image.jpg'">
            <div class="cat-info">
                <strong>${c.name} ${isPinned ? '<span class="pinned-badge">FIXADA</span>' : ''}</strong>
                <div class="cat-meta">
                    Criada em: ${new Date(c.created_at).toLocaleDateString('pt-BR')}
                </div>
            </div>
        `;
        
        div.onclick = (e) => { 
            if(!e.target.classList.contains('cat-btn')) 
                openCategory(c.id, c.name, c.thumb_url); 
        };
        
        container.appendChild(div);
    }

    async function createCategory() {
        const name = document.getElementById('newCatName').value;
        const thumb = document.getElementById('newCatThumb').value;
        if(!name || !thumb) return alert('Nome e Imagem s√£o obrigat√≥rios!');

        if (!thumb.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i) && !thumb.includes('i.ibb.co')) {
            if (!confirm('Este link n√£o parece ser uma imagem. Tem certeza que √© um link v√°lido?')) {
                return;
            }
        }

        try {
            const res = await fetch(`${API_URL}/categories`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, thumb_url: thumb, parent_id: null })
            });

            if(res.ok) {
                document.getElementById('newCatName').value = '';
                document.getElementById('newCatThumb').value = '';
                await loadCategories();
                alert('Categoria criada com sucesso!');
            } else {
                const errorData = await res.json();
                alert(errorData.error || 'Erro ao criar categoria');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao criar categoria');
        }
    }

    // --- SISTEMA DE CATEGORIAS E DIVISORES ---
    async function openCategory(id, name, thumb) {
        currentCategoryId = id;
        currentCategoryName = name;
        currentCategoryThumb = thumb;
        
        hideAllScreens();
        document.getElementById('categoryScreen').classList.remove('hidden');
        
        document.getElementById('currentCatTitle').innerText = name;
        document.getElementById('currentCatBreadcrumb').innerText = name;
        document.getElementById('backToCategoryBtn').innerText = name;
        document.getElementById('editorBackToCategoryBtn').innerText = name;
        document.getElementById('divisorBackToCategoryBtn').innerText = name;
        
        await loadDivisors();
    }

    async function loadDivisors() {
        try {
            const res = await fetch(`${API_URL}/categories/${currentCategoryId}/divisors`);
            if (!res.ok) throw new Error('Erro ao carregar divisores');
            
            const divisors = await res.json();
            const list = document.getElementById('divisorsList');
            list.innerHTML = '';

            if(divisors.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h4>Nenhum divisor encontrado</h4>
                        <p>Clique em "Criar Divisor" para adicionar o primeiro.</p>
                    </div>
                `;
                return;
            }

            divisors.forEach(d => {
                const row = document.createElement('div');
                row.className = 'divisor-list-item';
                row.innerHTML = `
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; display: block; margin-bottom: 5px;">${d.name}</strong>
                        <div style="font-size: 13px; color: #6c757d;">
                            Criado em: ${new Date(d.created_at).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-danger btn-sm" onclick="deleteDivisor(${d.id})">Apagar</button>
                    </div>
                `;
                row.onclick = () => openDivisor(d.id, d.name);
                list.appendChild(row);
            });
        } catch (error) {
            console.error('Erro ao carregar divisores:', error);
            const list = document.getElementById('divisorsList');
            list.innerHTML = `
                <div class="alert alert-error">
                    <strong>Erro ao carregar divisores:</strong> ${error.message}
                </div>
            `;
        }
    }

    function showDivisorCreator() {
        hideAllScreens();
        document.getElementById('divisorCreatorScreen').classList.remove('hidden');
        document.getElementById('divisorName').value = '';
    }

    function cancelDivisorCreator() {
        openCategory(currentCategoryId, currentCategoryName, currentCategoryThumb);
    }

    async function createDivisor() {
        const name = document.getElementById('divisorName').value;
        if(!name) return alert('Nome do divisor √© obrigat√≥rio!');

        try {
            const res = await fetch(`${API_URL}/categories`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    name: name, 
                    thumb_url: 'https://i.ibb.co/0jQY8L9/divider.png',
                    parent_id: currentCategoryId
                })
            });

            if(res.ok) {
                alert('Divisor criado com sucesso!');
                openCategory(currentCategoryId, currentCategoryName, currentCategoryThumb);
            } else {
                const errorData = await res.json();
                alert(errorData.error || 'Erro ao criar divisor');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao criar divisor');
        }
    }

    async function deleteDivisor(id) {
        if(confirm('Tem certeza que deseja apagar este divisor e todas as suas mat√©rias?')) {
            try {
                await fetch(`${API_URL}/categories/${id}`, { method: 'DELETE' });
                await loadDivisors();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar divisor');
            }
        }
    }

    async function openDivisor(id, name) {
        currentDivisorId = id;
        currentDivisorName = name;
        
        hideAllScreens();
        document.getElementById('divisorScreen').classList.remove('hidden');
        
        document.getElementById('currentDivisorTitle').innerText = name;
        document.getElementById('currentDivisorBreadcrumb').innerText = name;
        document.getElementById('editorBackToDivisorBtn').innerText = name;
        
        await loadPosts();
    }

    function backToCategory() {
        openCategory(currentCategoryId, currentCategoryName, currentCategoryThumb);
    }

    function backToDivisor() {
        openDivisor(currentDivisorId, currentDivisorName);
    }

    // --- CONTINUA√á√ÉO DO C√ìDIGO (fun√ß√µes restantes mantidas iguais) ---
    // [As fun√ß√µes restantes s√£o as mesmas do c√≥digo anterior...]

    // Fixar/Desfixar Categoria
    async function togglePinCategory(e, id, pinned) {
        e.stopPropagation();
        
        try {
            const res = await fetch(`${API_URL}/categories/${id}/pin`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pinned })
            });

            if(res.ok) {
                await loadCategories();
            } else {
                const data = await res.json();
                alert(data.error || 'Erro ao fixar categoria');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao fixar categoria');
        }
    }

    function editCategory(e, id, name, thumb) {
        e.stopPropagation();
        editingCategoryId = id;
        document.getElementById('editCatName').value = name;
        document.getElementById('editCatThumb').value = thumb;
        document.getElementById('editCategoryModal').classList.remove('hidden');
    }

    function editCurrentCategory() {
        if (!currentCategoryId) return;
        editingCategoryId = currentCategoryId;
        document.getElementById('editCatName').value = currentCategoryName;
        document.getElementById('editCatThumb').value = currentCategoryThumb;
        document.getElementById('editCategoryModal').classList.remove('hidden');
    }

    function closeEditCategoryModal() {
        document.getElementById('editCategoryModal').classList.add('hidden');
        editingCategoryId = null;
    }

    async function updateCategory() {
        const name = document.getElementById('editCatName').value;
        const thumb = document.getElementById('editCatThumb').value;
        
        if(!name || !thumb) return alert('Nome e Imagem s√£o obrigat√≥rios!');

        try {
            const res = await fetch(`${API_URL}/categories/${editingCategoryId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, thumb_url: thumb })
            });

            if(res.ok) {
                alert('Categoria atualizada com sucesso!');
                closeEditCategoryModal();
                await loadCategories();
                
                if (currentCategoryId === editingCategoryId) {
                    currentCategoryName = name;
                    currentCategoryThumb = thumb;
                    document.getElementById('currentCatTitle').innerText = name;
                }
            } else {
                alert('Erro ao atualizar categoria');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao atualizar categoria');
        }
    }

    async function deleteCategory(e, id) {
        e.stopPropagation();
        if(confirm('Tem certeza? Isso apaga todos os divisores e mat√©rias desta categoria.')) {
            try {
                await fetch(`${API_URL}/categories/${id}`, { method: 'DELETE' });
                await loadCategories();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar categoria');
            }
        }
    }

    // --- MAT√âRIAS ---
    async function loadPosts() {
        try {
            const res = await fetch(`${API_URL}/posts/${currentDivisorId}`);
            
            if (!res.ok) {
                throw new Error(`Erro ${res.status}: ${res.statusText}`);
            }
            
            const posts = await res.json();
            const list = document.getElementById('postsList');
            list.innerHTML = '';

            if(posts.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h4>Nenhuma mat√©ria encontrada</h4>
                        <p>Clique em "Criar Mat√©ria" para adicionar a primeira.</p>
                    </div>
                `;
                return;
            }

            posts.forEach(p => {
                const row = document.createElement('div');
                row.className = 'post-item';
                row.innerHTML = `
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; display: block; margin-bottom: 5px;">${p.title}</strong>
                        <div style="font-size: 13px; color: #6c757d;">
                            Por: ${p.author} | Em: ${new Date(p.created_at).toLocaleString('pt-BR')}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning btn-sm" onclick="editPost(${p.id}, '${p.title.replace(/'/g, "\\'")}', '${p.content.replace(/'/g, "\\'")}', '${p.media_urls ? p.media_urls.replace(/'/g, "\\'") : ''}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePost(${p.id})">Apagar</button>
                    </div>
                `;
                list.appendChild(row);
            });
        } catch (error) {
            console.error('Erro ao carregar mat√©rias:', error);
            const list = document.getElementById('postsList');
            list.innerHTML = `
                <div class="alert alert-error">
                    <strong>Erro ao carregar mat√©rias:</strong> ${error.message}
                    <br><br>
                    <small>Verifique sua conex√£o com a internet e tente novamente.</small>
                </div>
            `;
        }
    }

    // --- EDITOR DE MAT√âRIA ---
    async function showEditor() {
        hideAllScreens();
        document.getElementById('editorScreen').classList.remove('hidden');

        // Auto-fill
        document.getElementById('postAuthor').value = currentUser;
        document.getElementById('postDate').value = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        
        // Reset fields
        document.getElementById('postTitle').value = '';
        document.getElementById('postContent').value = '';
        document.getElementById('mediaInputs').innerHTML = '<input type="text" class="media-link" placeholder="Link da imagem ou v√≠deo...">';
    }

    function addMediaInput() {
        const div = document.createElement('div');
        div.innerHTML = '<input type="text" class="media-link" placeholder="Outro link de m√≠dia...">';
        document.getElementById('mediaInputs').appendChild(div);
    }

    function getMediaLinks() {
        const inputs = document.querySelectorAll('.media-link');
        let links = [];
        inputs.forEach(i => { if(i.value) links.push(i.value) });
        return links;
    }

    // --- EDI√á√ÉO DE MAT√âRIA ---
    function editPost(id, title, content, media_urls) {
        editingPostId = id;
        document.getElementById('editPostTitle').value = title;
        document.getElementById('editPostContent').value = content;
        
        // Preencher m√≠dias
        const mediaContainer = document.getElementById('editMediaInputs');
        mediaContainer.innerHTML = '';
        
        let mediaLinks = [];
        if (media_urls) {
            try {
                mediaLinks = JSON.parse(media_urls);
            } catch (e) {
                console.error('Erro ao parsear m√≠dias:', e);
            }
        }
        
        if (mediaLinks.length === 0) {
            mediaContainer.innerHTML = '<input type="text" class="edit-media-link" placeholder="Link da imagem ou v√≠deo...">';
        } else {
            mediaLinks.forEach(link => {
                mediaContainer.innerHTML += `<input type="text" class="edit-media-link" value="${link}" placeholder="Link da m√≠dia...">`;
            });
        }
        
        document.getElementById('editPostModal').classList.remove('hidden');
    }

    function addEditMediaInput() {
        const div = document.createElement('div');
        div.innerHTML = '<input type="text" class="edit-media-link" placeholder="Outro link de m√≠dia...">';
        document.getElementById('editMediaInputs').appendChild(div);
    }

    function getEditMediaLinks() {
        const inputs = document.querySelectorAll('.edit-media-link');
        let links = [];
        inputs.forEach(i => { if(i.value) links.push(i.value) });
        return links;
    }

    async function updatePost() {
        const title = document.getElementById('editPostTitle').value;
        const content = document.getElementById('editPostContent').value;
        
        if(!title || !content) {
            return alert('T√≠tulo e conte√∫do s√£o obrigat√≥rios!');
        }

        if(!confirm('Deseja atualizar esta mat√©ria?')) return;

        try {
            // Primeiro deleta a mat√©ria antiga
            await fetch(`${API_URL}/posts/${editingPostId}`, { method: 'DELETE' });
            
            // Depois cria a nova
            const postData = {
                category_id: currentDivisorId,
                title: title,
                author: currentUser,
                content: content,
                media_urls: getEditMediaLinks()
            };

            const res = await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(postData)
            });

            if(res.ok) {
                alert('Mat√©ria atualizada com sucesso!');
                closeEditPostModal();
                await loadPosts();
            } else {
                alert('Erro ao atualizar mat√©ria');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao atualizar mat√©ria');
        }
    }

    function closeEditPostModal() {
        document.getElementById('editPostModal').classList.add('hidden');
        editingPostId = null;
    }

    // --- PREVIEW ---
    function openPreview() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const categoriaNome = currentDivisorName;
        const links = getMediaLinks();
        
        document.getElementById('prevTitle').innerText = title || "Sem T√≠tulo";
        document.getElementById('prevMeta').innerText = `Por: ${currentUser} | Em: ${document.getElementById('postDate').value} | Divisor: ${categoriaNome}`;
        document.getElementById('prevText').innerText = content;

        const mediaDiv = document.getElementById('prevMedia');
        mediaDiv.innerHTML = '';
        
        if (links.length === 0) {
            mediaDiv.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 6px;">Nenhuma m√≠dia adicionada</p>';
        } else {
            links.forEach(link => {
                if(link.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i)) {
                    mediaDiv.innerHTML += `<img src="${link}" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px; display: block;">`;
                } else if (link.includes('youtube.com') || link.includes('youtu.be')) {
                    let videoId = '';
                    if (link.includes('youtube.com/watch?v=')) {
                        videoId = link.split('v=')[1].split('&')[0];
                    } else if (link.includes('youtu.be/')) {
                        videoId = link.split('youtu.be/')[1].split('?')[0];
                    }
                    
                    if (videoId) {
                        mediaDiv.innerHTML += `
                            <iframe width="100%" height="400" src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen style="border-radius: 8px; margin-bottom: 15px;"></iframe>
                        `;
                    } else {
                        mediaDiv.innerHTML += `<div style="background:#f8f9fa; padding:15px; margin-bottom:15px; text-align:center; border-radius: 6px;">
                            <a href="${link}" target="_blank" style="color: #e50914; text-decoration: none; font-weight: 600;">Assistir no YouTube ‚Üí</a>
                        </div>`;
                    }
                } else {
                    mediaDiv.innerHTML += `<div style="background:#f8f9fa; padding:15px; margin-bottom:15px; text-align:center; border-radius: 6px;">
                        <a href="${link}" target="_blank" style="color: #e50914; text-decoration: none; font-weight: 600;">Abrir M√≠dia ‚Üí</a>
                    </div>`;
                }
            });
        }

        document.getElementById('previewModal').classList.remove('hidden');
    }

    function closePreview() {
        document.getElementById('previewModal').classList.add('hidden');
    }

    // --- SALVAR MAT√âRIA ---
    async function savePost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        
        if(!title || !content) {
            return alert('T√≠tulo e conte√∫do s√£o obrigat√≥rios!');
        }

        if(!confirm('Deseja salvar esta mat√©ria?')) return;

        const postData = {
            category_id: currentDivisorId,
            title: title,
            author: currentUser,
            content: content,
            media_urls: getMediaLinks()
        };

        try {
            const res = await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(postData)
            });

            if(res.ok) {
                alert('Mat√©ria salva com sucesso!');
                backToDivisor();
            } else {
                alert('Erro ao salvar mat√©ria');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro de conex√£o ao salvar mat√©ria');
        }
    }

    async function deletePost(id) {
        if(confirm('Apagar esta mat√©ria?')) {
            try {
                await fetch(`${API_URL}/posts/${id}`, { method: 'DELETE' });
                await loadPosts();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar mat√©ria');
            }
        }
    }
</script>

</body>
</html>